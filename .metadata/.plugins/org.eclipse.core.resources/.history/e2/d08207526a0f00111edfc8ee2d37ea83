package com.tus.characters.service.impl;

import com.tus.characters.dto.CharacterDto;
import com.tus.characters.entity.Character;
import com.tus.characters.entity.User;
import com.tus.characters.repository.CharactersRepository;
import com.tus.characters.repository.UserRepository;
import com.tus.characters.service.ICharacterService;
import com.tus.characters.exception.ResourceNotFoundException;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CharacterServiceImpl implements ICharacterService {

    private final CharactersRepository charactersRepository;
    private final UserRepository userRepository; // for fetching User entity

    @Override
    public CharacterDto createCharacter(CharacterDto characterDto) {
        User user = userRepository.findById(characterDto.getUserId())
                .orElseThrow(() -> new ResourceNotFoundException(
                        "User", "userId", characterDto.getUserId().toString()));

        Character character = new Character();
        character.setUser(user);
        character.setCharacterClass(characterDto.getCharacterClass());
        character.setCharacterRace(characterDto.getCharacterRace());
        character.setLevel(characterDto.getLevel());

        Character savedCharacter = charactersRepository.save(character);
        return mapToDto(savedCharacter);
    }

    @Override
    public List<CharacterDto> getAllCharacters() {
        return charactersRepository.findAll()
                .stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Override
    public List<CharacterDto> getCharactersByUserId(Long userId) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new ResourceNotFoundException(
                        "User", "userId", userId.toString()));

        return charactersRepository.findByUserId(user.getUserId())
                .stream()
                .map(this::mapToDto)
                .collect(Collectors.toList());
    }

    @Override
    public void deleteCharacter(Long characterId) {
        Character character = charactersRepository.findById(characterId)
                .orElseThrow(() -> new ResourceNotFoundException(
                        "Character", "characterId", characterId.toString()));
        charactersRepository.delete(character);
    }

    // Helper mapper
    private CharacterDto mapToDto(Character character) {
        CharacterDto dto = new CharacterDto();
        dto.setUserId(character.getUser().getUserId());
        dto.setCharacterClass(character.getCharacterClass());
        dto.setCharacterRace(character.getCharacterRace());
        dto.setLevel(character.getLevel());
        return dto;
    }
}